<html>
  <head>
    <title>Testing JS timing</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      table{
        border-collapse: collapse;
      }
      button, select, input{
          padding: 5px;
          font-size: 120%;
      }
      th, td{
        border: 1px solid black;
        padding: 10px;
        text-align: center;
      }
      input{
          border: none;
          width: 5em;
      }
      .nopadding{
          padding:0;
      }
      .wide_input{
          width: 15em;
      }
    </style>
    <script>
      const MIN_PAYMENT = 1;
      const NUMB_OF_FIGURES = 0;
      var numb_of_all = 3;  // Defaults
      var controller = "";

      class Array_2d(){

          // Parametres: number of columns and rows:
          constructor(cols, rows){
              this.rows = rows;
              this.cols = cols;
              this.arr_2d = this.initiate();
          }
          // Set value to the cell at (x,y). x refers to col (width),
          // y to row (height) like in the coordinates system.
          set(value, x, y){

          }
          get(x,y){

          }
          // Initate array with the right size:
          initiate(){
              let arr = new Array[this.rows];
              for(let i = 0; i < arr.length; i++){
                  arr[i] = new Array(this.cols);
              }
          }
      }

      class Person{
          constructor(name, weight, paid){
              this.name = name;
              this.weight = weight;
              this.paid = paid;
              this.balance = 0;
          }
      }
      class Controller{
          constructor(){
              this.persons = [];
              this.the_rich = [];
              this.the_poor = [];
              this.payments = [][];
              this.total = this-count_total();
              this.weights_total = this.count_weights_total();
              this.vues = new Views();
          }
          // Counts and returns the sum of all the paid amounts.
          count_total(){
              let persons = this.persons;
              let sum = 0;
              for(let i=0; i < persons.length; i++){
                  sum += persons[i].paid;
              }
              return sum;
          }
          // Counts and returns the sum of all weights.
          // Note: the sum should not zero (division problem).
          // The caller takes care of the checking.
          }
          count_weights_total(){
              let persons = this.persons;
              let sum = 0;
              for(let i=0; i < persons.length; i++){
                  sum += persons[i].paid;
              }
              return sum;
          }
          // Returns an array of two arrays: persons having paid less than their
          // share and another array with all the rest. Divides all the persons into
          // two groups.
          // Also sets the balance of each person telling how much he/she must
          // pay or get from others.
          get_the_rich_and_the_poor(){
              let persons = this.persons;
              let paid_total = this.paid_total;
              let the_poor = [];
              let the_rich = [];
              let total_to_pay_for_person = 0;
              for(let i = 0; i < persons.length; i++){
                  let p = persons[i];
                  total_to_pay_for_person = this.personal_total_by_weight(p)

                  // Positive balance -> person must pay to someone. Negative->
                  // someone else ows him that much.
                  p.balance = personal_total_by_weight - p.paid;

                  // If person must pay -> adds to the persons in debt.
                  if(p.balance > 0){
                      the_poor[] = p;
                  } else{
                      the_rich[] = p;
                  }
              }
              return [the_poor, the_rich];
          }
          calculate(){
              // Clears the old values:
              this.clear_results();
              let groups = this.get_the_rich_and_the_poor();
              this.the_poor = groups[0];
              this.the_rich = groups[1];

              // Calculate the sum to pay for each poor person. The payment
              // is divided into parts based on the richÍ„s needs.. The sums
              // are written into the payments table (2-dim). The first row
              // like the first col are left empty (for the names).
              let x = 1;
              let y = 1;
              for(let i = 0; i < this.the_poor.length; i++){
                  let payer = this.the_poor[i];
                  for(let k = 0; k < this.the_rich.length; k++){
                      let rich_guy = this.the_rich[k];

                      // Balance must be > or = MIN_PAYMENT for payment need.
                      if(payer.balance < MIN_PAYMENT ||
                          Math.abs(rich_guy.balance < MIN_PAYMENT)){

                            // Nothing to pay:
                          this.payments[x][y] = "-";
                      }
                      // If there is still debt to pay:
                      else if(payer.balance > MIN_PAYMENT){
                          // How much to pay to this rich person?
                          let payment_exact =
                            Math.min(payer.balance, rich_guy.balance);
                          let payment = round_to(payment_exact, NUMB_OF_FIGURES);
                          payer.balance -= payment;
                          rich_guy.balance += payment;
                          this.payments[x][y] = payment;
                      }
                      // One step to the right: the next rich guy:
                      x++;
                  }
                  // New payer (one step down in the table):
                  y++;
                  // Jump to the column 2 (the 1st rich guy):
                  x = 1;
              }
          }
          // Add the names to the payments table (the rich row 1, the poor column 1)
          write_names_to_table(){
              let poor = "";
              let rich = "";
              for(let i = 0; i < this.the_poor.length; i++){
                  poor = this.the_poor[i];
                  this.payments[i][0] = poor.name;
              }
              for(let j = 0; j < this.the_rich.length; j++){
                  rich = this.the_rich[j];
                  this.payments[0][j] = poor.name;
              }
          }
      }
      class Views{
          constructor(){

          }
          make_infotable(numb){
              let html = "<table id='persons_table'>";
              html += "<tr><th></th><th>Name</th><th>Paid</th><th>Weight (%)</th></tr>";
              let index = 1;
              for(var i = 0; i < numb; i++){
                  index++;
                  html += "<tr><td>Person "+(i+1)+"</td>"+
                    "<td class='nopadding'>"+
                        "<input class='wide_input' id='name_"+index+"' type='text'>"+
                    "</td>"+
                    "<td class='nopadding'>"+
                        "<input id='paid_"+index+"' type='text'>"+
                    "</td>"+
                    "<td class='nopadding'>"+
                        "<input id='weight_"+index+"' type='text'>"+
                    "</td>"+
                    "</tr>";
              }
              html += "</table>";
              return html;
          }
          show_table(){
              let numb = this.get_elem("numb_of_all").value;
              numb_of_all = numb;
              let tbl = this.make_infotable(numb);
              this.set_content("persons",tbl);
          }
          // General help methods to handle HTML and DOM
          get_elem(id){
              return document.getElementById(id);
          }
          set_content(id,content){
              let elem = this.get_elem(id)
              elem.innerHTML = content;
          }
          // Helps with many similar options:
          add_option_elem(val, def){
              var selected = "";
              if (val === def){
                  selected = 'selected="selected"';
              }
              return '<option value="'+val+'" '+selected+'>'+val+'</option>';
          }

          // Options with numbers 1-number:
          create_option_elems(number, def){
              var options_html = "";
              for(var i = 0; i < number; i++){
                  options_html += this.add_option_elem(i+1,def);
              }
              return options_html;
          }
      }

      function init(){
          controller = new Controller();
          let vues = controller.vues;
          let numb = numb_of_all;
          let tbl = vues.make_infotable(numb);
          vues.set_content("persons",tbl);
      }


    </script>
  </head>
  <body onload="init()">
    <h1>Bill Solver</h1>
    <p id="guide">This application makes it easy to know how much each ows who.</p>
    <p id="question_number">
      <label for="numb_of_all">How many participated?</label>
      <select id="numb_of_all" onchange="controller.vues.show_table(this.value)">
        <script>
          vue = new Views(); // Seems to run before init()!
          document.write(vue.create_option_elems(100, 3))
        </script>
      </select>
      <!--<button onclick="show_table()">Show table</button>-->

    </p>
    <div id="persons"></div>
    <div id="result"></div>
    <p><button onclick="init()">Solve it</button></p>
    <script>

    </script>

  </body>
</html>
